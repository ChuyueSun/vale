include "../../../src/arch/x64/X64.Vale.Decls.vaf"

#verbatim interface implementation
module Quick
open X64.Machine_s
open X64.Vale
open X64.Vale.State_i
open X64.Vale.Decls
open X64.Vale.Quick_i
#endverbatim

#verbatim

unfold let normal_steps2 : list string =
  "X64.Vale.Decls.va_wp_Add64"::
  "X64.Vale.Decls.va_quick_Add64"::
  "Quick.codes_bench"::
  "Quick.wpCodes_bench"::
  normal_steps

unfold let normal (x:Type0) : Type0 = norm [iota; zeta; simplify; primops; delta_only normal_steps2] x

val wp_sound_norm (#a:Type0) (cs:codes) (fcs:quickCodes a cs) (s0:state) (p:state -> state -> a -> Type0) :
  Ghost (state * fuel * a)
    (normal (wp_sound_pre fcs s0 p))
    (wp_sound_post fcs s0 p)
let wp_sound_norm = wp_sound_wrap

[@"opaque_to_smt"]
let codes_bench : codes = [
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);

  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);

  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);

  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);
  va_code_Add64 (OReg Rax) (OConst 1);

  ]

[@"opaque_to_smt"]
let wpCodes_bench : quickCodes unit codes_bench =
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (

  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (

  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (

  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (

  QEmpty ()
  )))))
  )))))
  )))))
  )))))

//#reset-options "--debug Quick --debug_level SMTQuery"

let lemma_bench1 (s0:state) : Ghost (state * fuel)
  (requires
    s0.ok /\
    s0.regs Rax < 100
  )
  (ensures fun (sN, f0) ->
    eval (Block codes_bench) s0 f0 sN /\
    sN.ok /\
    sN.regs Rax == s0.regs Rax + 20 /\
    va_state_eq sN (va_update_reg Rax sN (va_update_flags sN s0))
  )
  =
  let (sN, f0, ()) = wp_sound_norm codes_bench wpCodes_bench s0
    (fun s0 sN () ->
      sN.ok /\
      sN.regs Rax == s0.regs Rax + 20 /\
      va_state_match sN (va_update_reg Rax sN (va_update_flags sN s0))
    )
    in
  (sN, f0)
//#reset-options ""
#endverbatim

procedure{:quick exportOnly} Add64Ghosts(
        inout dst:dst_opr64,
        src:opr64,
        inline i:int,
        ghost b:buffer64,
        ghost g1:int,
        ghost g2:int)
    returns(
        ghost h1:int,
        ghost h2:int)
    modifies
        efl;
    requires
        i > 2;
        g1 == src;
        g2 > 3;
        src + dst < nat64_max;
    ensures
        h1 == g1;
        h2 > 4;
        eq_int(dst, old(dst + src));
{
    h1 := g1;
    h2 := g2 + 1;
    Add64(dst, src);
}

(*
#verbatim
unfold let va_normal_Add3 (x:Type0) : Type0 =
  norm [
    iota; zeta; simplify; primops;
    delta_only (
      "X64.Vale.Decls.va_wp_Add64"::
      "X64.Vale.Decls.va_quick_Add64"::
      "Quick.va_code_Add3"::
      "Quick.va_qcode_Add3"::
      normal_steps
    )
  ]
  x

val va_wpSound_Add3 (#a:Type0) (c:code) (qc:quickCode a c) (s0:state) (p:state -> state -> a -> Type0) :
  Ghost ((sN:state) * (fN:fuel) * (g:a))
    (va_normal_Add3 (wp_sound_code_pre qc s0 p))
    (wp_sound_code_post qc s0 p)
let va_wpSound_Add3 = wp_sound_code_wrap

[@"opaque_to_smt"]
let va_qcode_Add3 () : quickCode unit (va_code_Add3 ()) = qblock (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QSeq (va_quick_Add64 (OReg Rax) (OConst 1)) (
  QEmpty ()
  )))
)
#endverbatim

procedure{:quick} Add3()
    modifies
        efl;
        rax;
    requires
        rax < 100;
    ensures
        rax == old(rax) + 3;
{
    Add64(rax, 1);
    Add64(rax, 1);
    Add64(rax, 1);
}
*)

